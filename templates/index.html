<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="description" content="Find and book premium student boarding houses. Verified listings for MyWay students.">
    <title>MyWay | Live Better</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">

    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/icon-192.png') }}">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#007AFF">
    
    <style>
        :root { --blue: #007AFF; --bg: #F2F2F7; --orange: #FF9500; --red: #FF3B30; --text-main: #1C1C1E; --text-muted: #636366; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text-main); min-height: 100vh; padding-bottom: env(safe-area-inset-bottom); }
        header { background: linear-gradient(135deg, #0062ff, #00d4ff); padding: calc(40px + env(safe-area-inset-top)) 25px 120px; color: white; border-radius: 0 0 50px 50px; text-align: center; }
        
        .sheet-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); display: none; opacity: 0; z-index: 2000; transition: 0.3s; backdrop-filter: blur(4px); }
        .sheet-overlay.active { display: block; opacity: 1; }
        
        .bottom-sheet { position: fixed; bottom: -100%; left: 0; width: 100%; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border-radius: 30px 30px 0 0; z-index: 2001; transition: 0.4s cubic-bezier(0.32, 0.72, 0, 1); padding: 20px 20px calc(20px + env(safe-area-inset-bottom)); max-height: 80vh; overflow-y: auto; }
        .bottom-sheet.active { bottom: 0; }
        
        .sheet-item { padding: 18px; text-align: center; font-size: 1.1rem; font-weight: 700; border-bottom: 1px solid rgba(0,0,0,0.05); color: var(--blue); cursor: pointer; }
        .logo-row { display: flex; justify-content: space-between; align-items: center; max-width: 600px; margin: 0 auto 30px; position: relative; z-index: 10; }
        .menu-trigger { font-size: 1.8rem; cursor: pointer; padding: 10px; border: none; background: none; color: white; }
        
        .glass-search { width: 100%; padding: 18px 25px; border-radius: 25px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.2); backdrop-filter: blur(15px); color: white; outline: none; font-size: 1rem; }
        .glass-search::placeholder { color: rgba(255,255,255,0.8); }
        
        .selector-box { max-width: 450px; margin: -45px auto 40px; padding: 0 20px; z-index: 10; position: relative; }
        .floating-trigger { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 25px; padding: 18px 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.06); display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        
        .content { max-width: 600px; margin: 0 auto; padding: 0 20px 40px; }
        .card { background: white; border-radius: 35px; padding: 20px; margin-bottom: 30px; position: relative; border: 1px solid #E5E5EA; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.03); }
        .badge { position: absolute; top: 35px; left: 35px; background: var(--blue); color: white; padding: 6px 14px; border-radius: 12px; font-size: 0.7rem; font-weight: 800; z-index: 5; }
        
        .img-stack { display: flex; overflow-x: auto; gap: 12px; margin: -20px -20px 20px; padding: 20px; scroll-snap-type: x mandatory; scrollbar-width: none; }
        .img-stack::-webkit-scrollbar { display: none; }
        .img-stack img { width: 92%; height: 280px; object-fit: cover; border-radius: 28px; scroll-snap-align: center; flex-shrink: 0; background: #eee; }
        
        .wa-btn { background: #34C759; color: white; text-decoration: none; padding: 15px 20px; border-radius: 20px; font-weight: 800; flex: 1; text-align: center; }
        .footer-branding { text-align: center; padding: 40px; font-size: 0.8rem; color: #636366; font-weight: 800; }
    </style>
</head>
<body>

    <div class="sheet-overlay" id="sheetOverlay" onclick="closeAllSheets()"></div>

    <nav class="bottom-sheet" id="mainMenu" aria-label="Main Menu">
        <div style="width: 40px; height: 5px; background: #D1D1D6; border-radius: 10px; margin: 0 auto 20px;"></div>
        <div class="sheet-item" onclick="window.location.href='/landlord'">Landlord Portal</div>
        <div class="sheet-item" onclick="window.location.href='/admin'" style="color: var(--orange);">Admin Dashboard</div>
        <div class="sheet-item" onclick="enableNotifications()" style="color: var(--blue);">Enable Notifications</div>
        <div class="sheet-item" onclick="updateApp()" style="color: #34C759;">Check for Updates</div>
        <div class="sheet-item" onclick="closeAllSheets()" style="color:#8E8E93">Cancel</div>
    </nav>

    <div class="bottom-sheet" id="schoolSheet">
        <div style="width: 40px; height: 5px; background: #D1D1D6; border-radius: 10px; margin: 0 auto 20px;"></div>
        <div class="sheet-item" onclick="selectSchool('', 'All Institutions')">All Institutions</div>
        {% for s in schools %}
        <div class="sheet-item" onclick="selectSchool('{{ s.name }}', '{{ s.name }}')">{{ s.name }}</div>
        {% endfor %}
    </div>

    <header>
        <div class="logo-row">
            <div class="logo" style="font-weight:800; font-size:1.6rem;">MYWAY</div>
            <button class="menu-trigger" onclick="openSheet('mainMenu')" aria-label="Open Menu">‚ò∞</button>
        </div>
        <h1 style="font-size:2.2rem; font-weight:800; margin:0;">Upgrade your stay.</h1>
        <input type="text" id="find" class="glass-search" style="margin-top:30px;" placeholder="Search area or house..." onkeyup="filter()" aria-label="Search houses">
    </header>

    <div class="selector-box">
        <div class="floating-trigger" onclick="openSheet('schoolSheet')">
            <span id="displaySchool" style="font-weight: 800;">All Institutions</span>
            <span style="color: var(--blue);" aria-hidden="true">‚ñº</span>
        </div>
    </div>

    <main class="content" id="list">
        {% for h in houses %}
        <article class="card" data-name="{{ h.name }}" data-loc="{{ h.location }}" data-inst="{{ h.institution }}">
            <div class="badge">VERIFIED</div>
            <div class="img-stack">
                {% if h.images %}{% for img in h.images.split(',') %}
                <img src="{{ url_for('static', filename='uploads/' + img) }}" loading="lazy" alt="{{ h.name }} interior">
                {% endfor %}{% endif %}
            </div>
            <h2 style="margin: 0 0 5px 0;">{{ h.name }}</h2>
            <p style="color: var(--text-muted); margin: 0 0 15px 0;">üìç {{ h.location }}</p>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:1.4rem; font-weight:800; color:var(--blue);">K{{ h.price }}</span>
                <a href="https://wa.me/{{ h.phone }}" class="wa-btn">Contact</a>
            </div>
        </article>
        {% endfor %}
    </main>

    <footer class="footer-branding"> POWERED BY VECTAREV 2026 </footer>

    <script>
        // UI Logic
        function openSheet(id) {
            document.getElementById('sheetOverlay').style.display = 'block';
            setTimeout(() => document.getElementById('sheetOverlay').classList.add('active'), 10);
            document.getElementById(id).classList.add('active');
        }
        function closeAllSheets() {
            document.getElementById('sheetOverlay').classList.remove('active');
            document.querySelectorAll('.bottom-sheet').forEach(s => s.classList.remove('active'));
            setTimeout(() => document.getElementById('sheetOverlay').style.display = 'none', 300);
        }
        function selectSchool(val, name) {
            document.getElementById('displaySchool').innerText = name;
            selectedSchool = val;
            closeAllSheets();
            filter();
        }
        let selectedSchool = "";
        function filter() {
            let q = document.getElementById('find').value.toLowerCase();
            document.querySelectorAll('.card').forEach(c => {
                let text = (c.dataset.name + c.dataset.loc).toLowerCase();
                let inst = c.dataset.inst.toLowerCase();
                c.style.display = (text.includes(q) && (selectedSchool === "" || inst.includes(selectedSchool.toLowerCase()))) ? "block" : "none";
            });
        }

        // PWA: Update Logic
        async function updateApp() {
            if ('serviceWorker' in navigator) {
                const reg = await navigator.serviceWorker.getRegistration();
                if (reg) {
                    await reg.update();
                    alert("Checking for updates... App will refresh if a new version is found.");
                    if (reg.waiting) {
                        reg.waiting.postMessage({ type: 'SKIP_WAITING' });
                        window.location.reload();
                    }
                }
            }
        }

        // PWA: Notification Logic
        function enableNotifications() {
            if (!("Notification" in window)) return alert("This browser does not support notifications.");
            Notification.requestPermission().then(permission => {
                if (permission === "granted") alert("Notifications enabled!");
            });
        }

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js');
            });
        }
    </script>
</body>
</html>